---
title: "<center>Expenses</center>"
subtitle: "Table of Contents"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 8, fig.align = "center")

library(tidyverse)
library(googlesheets4)
library(DT)

authenticated <- FALSE
tryCatch(
  {
    # Create email.txt file (not included in Git repo)
    # Set use_oob = FALSE for initial run
    gs4_auth(email = read_lines("email.txt"), scopes = "spreadsheets.readonly", use_oob = TRUE)
    authenticated <- TRUE
  },
  error = function(err) {
    message("User is not authenticated.")
  })
source("tools/get_data.R")

theme_update(plot.title = element_text(hjust = 0.5), 
             plot.subtitle = element_text(hjust = 0.5),
             panel.background = element_blank(),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             axis.line = element_line(color = "black"))
```

All data in this report is **`r if_else(authenticated, "REAL", "SIMULATED")`**.

# Groceries
Note: Grocery data does not include Costco, as groceries are only a small portion of our expenses from that store.

```{r grocery-data, include=FALSE}
grocery_sheet <- get_grocery_data(authenticated)
grocery <- grocery_sheet %>% 
  arrange(date) %>% 
  mutate(date = as.Date(date),
         store = as.factor(store),
         cost_per_item = cost / items,
         week = floor_date(date, unit = "week"),
         month = floor_date(date, unit = "month"),
         year = year(date)) %>% 
  group_by(store) %>% 
  mutate(store_label = as.factor(ifelse(n() < 3, "Other", as.character(store)))) %>% 
  ungroup()
grocery$store_label <- factor(grocery$store_label, 
                              levels = c(setdiff(levels(grocery$store_label), "Other"), 
                                         "Other")
)

grocery_last365 <- filter(grocery, date >= as.Date("2025-01-09")) # Once a year has passed, change this to the last 365 days
# grocery_last365 <- filter(grocery, date >= today() - days(365))
```

## Grocery Expenses over Time
### Grocery Expenses by Week
From 01/09/2025 (when we started continuously tracking trips to the grocery store) to `r format(max(grocery$date), "%m/%d/%Y")`, we went to the grocery store `r sum(grocery$date >= as.Date("2025-01-09"))` times: an average of `r round(sum(grocery$date >= as.Date("2025-01-09")) / as.numeric(difftime(max(grocery$date), as.Date("2025-01-09"), units = "weeks")), 2)` times per week.

Below is the total expenditure per week, with each color in the stacked bar chart corresponding to the amount spent at a given store that week. Stores that have been visited less than three times are grouped as "Other".

```{r grocery-week}
mean_weekly_cost <- mean(summarize(group_by(grocery_last365, week), 
                                   cost = sum(cost),
                                   .groups = "drop")$cost)
grocery_last365 %>% 
  ggplot(aes(x = week, y = cost)) +
  geom_col(aes(fill = store_label)) +
  geom_hline(yintercept = mean_weekly_cost,
             linetype = "dashed", linewidth = 1.5) +
  annotate("label", x = as.Date(min(grocery_last365$week) - days(14)), 
           y = mean_weekly_cost, 
           label = round(mean_weekly_cost, 2)) +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  labs(title = "Grocery Expenses by Week",
       x = "Week",
       y = "Expenditure ($)",
       fill = NULL) +
  theme(axis.line = element_blank())
```

Below are plots of the number of trips per week and expenditure per week over time, to see if there is any directional or seasonal change.

```{r grocery-week-trips-cost, out.width="50%", fig.align="default"}
week_summary <- grocery_last365 %>%
  group_by(year, week) %>%
  summarize(trips = n(), cost = sum(cost), .groups = "drop")

week_summary %>% 
  ggplot(aes(x = week, y = trips)) +
  geom_line(col = "blue") +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  labs(title = "Trips to the Grocery Store by Week",
       x = "Week", 
       y = "Number of Trips")

week_summary %>% 
  ggplot(aes(x = week, y = cost)) +
  geom_line() +
  geom_point(aes(size = trips), col = "blue") +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  guides(size = guide_legend(nrow = 1)) +
  theme(legend.position = "top") +
  labs(title = "Grocery Expenses by Week",
       x = "Week", 
       y = "Expenditure ($)",
       size = "Trips")
```

The following plot displays the relationship between the number of trips taken per week and the total expenditure; each point represents one week. The blue line is a third-degree polynomial fit to the data to show the larger trend. Note that points have been jittered to reduce overlap; trips can only be a whole number.

```{r grocery-weekly-cost}
week_fit <- lm(cost ~ poly(trips, 3), data = week_summary)
r2_week <- summary(week_fit)$r.squared

week_summary %>% 
  ggplot(aes(x = trips, y = cost)) +
  geom_jitter(width = 0.25, height = 0) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  scale_x_continuous(n.breaks = 10) +
  # scale_y_continuous(breaks = seq(0, max(sum(group_by(grocery_last365, week)$cost)), 25)) +
  labs(title = "Weekly Cost by Number of Trips",
       subtitle = paste0("R-squared = ", round(r2_week, 2)),
       x = "Trips per Week",
       y = "Weekly Expenditure ($)")
```

### Grocery Expenses by Month
We will now repeat each plot, this time aggregating over a month instead of week.

```{r grocery-month}
mean_monthly_cost <- mean(summarize(group_by(grocery_last365, month), 
                                    cost = sum(cost),
                                    .groups = "drop")$cost)
grocery_last365 %>% 
  group_by(year, month) %>% 
  ggplot(aes(x = month, y = cost)) +
  geom_col(aes(fill = store_label)) +
  geom_hline(yintercept = mean_monthly_cost,
             linetype = "dashed", linewidth = 1.5) +
  annotate("label", x = min(grocery_last365$month) - days(14), y = mean_monthly_cost, 
           label = round(mean_monthly_cost, 2)) +
  scale_x_date(breaks = "1 month", date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  labs(title = "Grocery Expenses by Month",
       x = NULL,
       y = "Expenditure ($)",
       fill = NULL) +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())
```

```{r grocery-month-trips-cost, out.width="50%", fig.align="default"}
month_summary <- grocery_last365 %>% 
  group_by(year, month) %>% 
  summarize(trips = n(), cost = sum(cost), .groups = "drop")

month_summary %>% 
  ggplot(aes(x = month, y = trips)) +
  geom_line(col = "blue") +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  theme(legend.position = "bottom") +
  labs(title = "Trips to the Grocery Store by Month",
       x = "Month", 
       y = "Number of Trips",
       col = "Expenditure ($)")

month_summary %>% 
  ggplot(aes(x = month, y = cost)) +
  geom_line() +
  geom_point(aes(size = trips), col = "blue") +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  theme(legend.position = "top") +
  labs(title = "Grocery Expenses by Month",
       x = "Month", 
       y = "Expenditure ($)",
       size = "Trips")
```

```{r grocery-monthly-cost}
month_fit <- lm(cost ~ poly(trips, 3), data = month_summary)
r2_month <- summary(month_fit)$r.squared

month_summary %>% 
  ggplot(aes(x = trips, y = cost)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  scale_x_continuous(breaks = seq(2, max(count(grocery_last365, month)$n), 2)) +
  # scale_y_continuous(breaks = seq(0, max(sum(group_by(grocery_last365, month)$cost)), 50)) +
  labs(title = "Monthly Cost by Number of Trips",
       subtitle = paste0("R-squared = ", round(r2_month, 2)),
       x = "Trips",
       y = "Monthly Total ($)")
```


## Grocery Expenses by Store
For the store analysis, we include the inconsistent receipts saved prior to 01/09/2025. The table is sorted in descending order by number of trips.

```{r grocery-stores-week}
grocery %>% 
  group_by(store) %>% 
  summarize(trips = n(), 
            mean_items = format(round(mean(items), 2), nsmall = 2),
            sd_items = format(round(sd(items), 2), nsmall = 2), 
            mean_cost = format(round(mean(cost), 2), nsmall = 2), 
            mean_cost_per_item = format(round(sum(cost) / sum(items), 2), nsmall = 2),
            min_cost = format(min(cost), nsmall = 2), 
            max_cost = format(max(cost), nsmall = 2)) %>% 
  arrange(desc(trips)) %>% 
  datatable()

grocery %>% 
  ggplot(aes(x = store_label, y = cost)) +
  geom_boxplot(varwidth = TRUE) +
  labs(title = "Distribution of Expenditures by Store",
       subtitle = paste0(format(min(grocery$date), "%m/%d/%Y"), " - ", 
                         format(max(grocery$date), "%m/%d/%Y")),
       x = "Store", 
       y = "Expenditure ($)") +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())
```

Note that for Trader Joe's and Wegmans, the number of items is counted manually, so errors may be present.

We will now plot the ratio of number of items and cost. Only stores that have been visited three or more times will be plotted.

```{r item-cost-scatterplot}
grocery %>% 
  filter(store_label != "Other") %>% # Only include stores that have been visited 3+ times
  ggplot(aes(x = items, y = cost, col = store)) +
  geom_point(size = 2) +
  geom_abline(intercept = 0, slope = sum(grocery$cost) / sum(grocery$items), 
              linetype = "dashed", linewidth = 1) +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  labs(title = "Grocery Stores by Average Item Cost",
       subtitle = paste0(format(min(grocery$date), "%m/%d/%Y"), " - ", 
                         format(max(grocery$date), "%m/%d/%Y")),
       caption = "Note: the dashed line is the overall average cost per item",
       x = "Number of Items Purchased",
       y = "Expenditure ($)",
       col = NULL) +
  theme(legend.position = "inside", legend.position.inside = c(0.1, 0.75), 
        plot.caption = element_text(hjust = 0))
```

The dashed line in the plot above represents the overall average cost per item (*x*-intercept = 0 items, slope = mean cost).


# Credit Cards

# Utilities

# Overall Monthly Expenses
