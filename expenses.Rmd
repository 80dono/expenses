---
title: "<center>Donofrio Expenses</center>"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 8, fig.align = "center")

library(tidyverse)
library(googlesheets4)
library(DT)
# library(fable)
source("tools/generate_sample_data.R")

theme_update(plot.title = element_text(hjust = 0.5), 
             plot.subtitle = element_text(hjust = 0.5))
```

# Groceries

```{r read-grocery-data, include=FALSE}
get_grocery_data <- function() {
  tryCatch({
    # Read from Google sheet if possible
    gs4_auth(email = read_lines("email.txt"))
    data <- read_sheet("https://docs.google.com/spreadsheets/d/1-qP05bK-Vwapjy7cE382MNJpsaJebitlniGzDfrw-7k/edit?gid=0#gid=0",
                       range = "Groceries") %>% 
      mutate(real = TRUE)
    return(data)
    },
    error = function(err) {
      # Use sample data if unable to read sheet
      message("Unable to access data; generating sample data instead.")
      sample_data <- generate_sample_grocery_data(months = 5)
      return(sample_data)
      })
}
```

```{r grocery-data, include=FALSE}
grocery_sheet <- get_grocery_data()
grocery <- grocery_sheet %>% 
  arrange(date) %>% 
  mutate(store = as.factor(store),
         cost_per_item = cost / items,
         week = floor_date(date, unit = "week"),
         month = floor_date(date, unit = "month")) %>% 
  group_by(store) %>% 
  mutate(store_label = as.factor(ifelse(n() < 3, "Other", as.character(store)))) %>% 
  ungroup()
grocery$store_label = factor(grocery$store_label, levels = c(levels(grocery$store_label)[2:nlevels(grocery$store_label)], 
                                                             "Other"))
grocery2025 <- filter(grocery, date >= as.Date("2025-01-09"))
```

## Grocery Expenses over Time
### Grocery Expenses by Week
From 01/09/2025 (when we started tracking trips to the grocery store) to `r format(max(grocery$date), "%m/%d/%Y")`, we went to the grocery store `r sum(grocery$date >= as.Date("2025-01-09"))` times: an average of `r round(sum(grocery$date >= as.Date("2025-01-09")) / as.numeric(difftime(max(grocery$date), as.Date("2025-01-09"), units = "weeks")), 2)` times per week.

```{r grocery-week}
grocery2025 %>% 
  ggplot(aes(x = week, y = cost)) +
  geom_col(aes(fill = store_label)) +
  geom_hline(yintercept = mean(summarize(group_by(grocery2025, week), 
                                         cost = sum(cost),
                                         .groups = "drop")$cost),
             linetype = "dashed", linewidth = 1.5) +
  scale_y_continuous(n.breaks = 10) +
  labs(title = "Grocery Expenses by Week",
       x = "Week",
       y = "Expenditure ($)",
       fill = "Store")
```

```{r grocery-week-trips-cost, out.width="50%", fig.align="default"}
grocery2025 %>% 
  group_by(week) %>% 
  summarize(trips = n(), cost = sum(cost), .groups = "drop") %>% 
  ggplot(aes(x = week, y = trips)) +
  geom_line() +
  geom_point(aes(col = cost), size = 3) +
  scale_color_gradient(low = "green", high = "red") +
  scale_y_continuous(n.breaks = 10) +
  theme(legend.position = "bottom") +
  labs(title = "Trips to the Grocery Store by Week",
       x = "Week", 
       y = "Number of Trips",
       col = "Expenditure ($)")

grocery2025 %>% 
  group_by(week) %>% 
  summarize(trips = n(), cost = sum(cost), .groups = "drop") %>% 
  ggplot(aes(x = week, y = cost)) +
  geom_line() +
  geom_point(aes(size = trips), col = "blue") +
  scale_y_continuous(n.breaks = 10) +
  theme(legend.position = "bottom") +
  labs(title = "Grocery Expenses by Week",
       x = "Week", 
       y = "Expenditure ($)",
       size = "Trips")
```

```{r grocery-weekly-cost}
grocery2025 %>% 
  group_by(week) %>% 
  summarize(trips = n(), cost = sum(cost), .groups = "drop") %>% 
  ggplot(aes(x = trips, y = cost)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(breaks = seq(0, max(sum(group_by(grocery2025, week)$cost)), 25)) +
  labs(title = "Weekly Cost by Number of Trips",
       x = "Trips per Week",
       y = "Weekly Total")
```

### Grocery Expenses by Month
```{r grocery-month}
grocery2025 %>% 
  group_by(month) %>% 
  ggplot(aes(x = month(date, label = TRUE), y = cost)) +
  geom_col(aes(fill = store_label)) +
  geom_hline(yintercept = mean(summarize(group_by(grocery2025, month), 
                                         cost = sum(cost),
                                         .groups = "drop")$cost),
             linetype = "dashed", linewidth = 1.5) +
  scale_y_continuous(n.breaks = 10) +
  labs(title = "Grocery Expenses by Month",
       x = "Month",
       y = "Expenditure ($)",
       fill = "Store")
```

```{r grocery-month-trips-cost, out.width="50%", fig.align="default"}
grocery2025 %>% 
  group_by(month) %>% 
  summarize(trips = n(), cost = sum(cost), .groups = "drop") %>% 
  ggplot(aes(x = month, y = trips)) +
  geom_line() +
  geom_point(aes(col = cost), size = 3) +
  scale_color_gradient(low = "green", high = "red") +
  scale_y_continuous(n.breaks = 10) +
  theme(legend.position = "bottom") +
  labs(title = "Trips to the Grocery Store by Month",
       x = "Month", 
       y = "Number of Trips",
       col = "Expenditure ($)")

grocery2025 %>% 
  group_by(month) %>% 
  summarize(trips = n(), cost = sum(cost), .groups = "drop") %>% 
  ggplot(aes(x = month, y = cost)) +
  geom_line() +
  geom_point(aes(size = trips), col = "blue") +
  scale_y_continuous(n.breaks = 10) +
  theme(legend.position = "bottom") +
  labs(title = "Grocery Expenses by Month",
       x = "Month", 
       y = "Expenditure ($)",
       size = "Trips")
```

```{r grocery-monthly-cost}
grocery2025 %>% 
  group_by(month) %>% 
  summarize(trips = n(), cost = sum(cost), .groups = "drop") %>% 
  ggplot(aes(x = trips, y = cost)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(breaks = seq(0, max(sum(group_by(grocery2025, month)$cost)), 25)) +
  labs(title = "Monthly Cost by Number of Trips",
       x = "Trips",
       y = "Monthly Total")
```


## Grocery Expenses by Store
For the store analysis, we include the inconsistent receipts saved prior to 01/09/2025. The table is sorted in descending order by number of trips.

```{r grocery-stores-week}
grocery %>% 
  group_by(store) %>% 
  summarize(trips = n(), 
            mean_items = format(round(mean(items), 2), nsmall = 2),
            sd_items = format(round(sd(items), 2), nsmall = 2), 
            mean_cost = format(round(mean(cost), 2), nsmall = 2), 
            mean_cost_per_item = format(round(sum(cost) / sum(items), 2), nsmall = 2),
            min_cost = format(min(cost), nsmall = 2), 
            max_cost = format(max(cost), nsmall = 2)) %>% 
  arrange(desc(trips)) %>% 
  datatable()

grocery %>% 
  ggplot(aes(x = store_label, y = cost)) +
  geom_boxplot(varwidth = TRUE) +
  labs(title = "Distribution of Expenditures by Store",
       subtitle = paste0(format(min(grocery$date), "%m/%d/%Y"), " - ", 
                         format(max(grocery$date), "%m/%d/%Y")),
       x = "Store", 
       y = "Expenditure ($)")
```

The table above shows that Giant typically has a slightly higher average cost per item than Trader Joe's. Wegmans is a higher average cost but may be affected by the wider range of higher-cost, non-grocery items (such as hygiene products and kitchenware), as it is the preferred store for purchasing those.

Note that for Trader Joe's and Wegmans, the number of items is counted manually, so errors may be present.

We will now plot the ratio of number of items and cost.

```{r item-cost-scatterplot}
grocery %>% 
  ggplot(aes(x = items, y = cost, col = store)) +
  geom_point(size = 2) +
  geom_abline(intercept = 1, slope = sum(grocery$cost) / sum(grocery$items), 
              linetype = "dashed", linewidth = 1) +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  scale_x_continuous(n.breaks = 10) +
  scale_y_continuous(n.breaks = 10) +
  labs(title = "Grocery Stores by Average Item Cost",
       subtitle = paste0(format(min(grocery$date), "%m/%d/%Y"), " - ", 
                         format(max(grocery$date), "%m/%d/%Y")),
       caption = "Note: the dashed line is the overall average cost per item",
       x = "Number of Items Purchased",
       y = "Expenditure ($)",
       col = "Store") +
  theme(legend.position = "inside", legend.position.inside = c(0.1, 0.72), 
        plot.caption = element_text(hjust = 0))
```

The dashed line in the plot above represents the overall average cost per item (*x*-intercept = 1 item, slope = mean cost). The three main stores all share a similar slope, though Wegmans is shifted higher (see previous commentary on mean item cost), while Trader Joe's is shifted lower and has a slightly shallower slope.


# Credit Cards

# Utilities

# Overall Monthly Expenses
