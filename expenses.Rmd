---
title: "<center>Expenses</center>"
subtitle: "Table of Contents"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 8, fig.align = "center")

library(tidyverse)
library(googlesheets4)
library(DT)
library(scales)
library(tsibble)
library(cowplot)

authenticated <- FALSE
tryCatch(
  {
    # Initial steps:
    #    - Create email.txt file (not included in Git repo)
    #    - Set use_oob = FALSE for initial run
    gs4_auth(email = read_lines("email.txt"), scopes = "spreadsheets.readonly", use_oob = TRUE)
    authenticated <- TRUE
  },
  error = function(err) {
    message("User is not authenticated.")
  })
source("tools/get_data.R")

theme_update(plot.title = element_text(hjust = 0.5), 
             plot.subtitle = element_text(hjust = 0.5),
             panel.background = element_blank(),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             axis.line = element_line(color = "black"))
palette4 <- hue_pal()(4)
```

All data in this report is **`r if_else(authenticated, "REAL", "SIMULATED")`**.

# Groceries
Note: Grocery data does not include Costco, as groceries are only a small portion of our expenses from that store.

```{r grocery-data, include=FALSE}
grocery_sheet <- get_grocery_data(authenticated)
grocery <- grocery_sheet %>% 
  arrange(date) %>% 
  mutate(date = as.Date(date),
         store = as.factor(store),
         cost_per_item = cost / items,
         shopper = as.factor(shopper),
         week = floor_date(date, unit = "week"),
         month = floor_date(date, unit = "month"),
         year = year(date)) %>% 
  group_by(store) %>% 
  mutate(store_label = as.factor(ifelse(n() < 5, "Other", as.character(store)))) %>% 
  ungroup()
grocery$store_label <- factor(grocery$store_label, 
                              levels = c(setdiff(levels(grocery$store_label), "Other"), 
                                         "Other")
)

grocery_last365 <- filter(grocery, date >= today() - days(365))
```

## Grocery Expenses over Time
### Grocery Expenses by Week
From 01/10/2025 (when we started continuously tracking trips to the grocery store) to `r format(max(grocery$date), "%m/%d/%Y")`, we went to the grocery store `r sum(grocery$date >= as.Date("2025-01-09"))` times: an average of `r round(sum(grocery$date >= as.Date("2025-01-09")) / as.numeric(difftime(max(grocery$date), as.Date("2025-01-09"), units = "weeks")), 2)` times per week. All grocery data going forward will only use the last 365 days as reference.

Below is the total expenditure per week, with each color in the stacked bar chart corresponding to the amount spent at a given store that week. Stores that have been visited less than five times are grouped as "Other".

```{r grocery-week}
mean_weekly_cost <- mean(summarize(group_by(grocery_last365, week), 
                                   cost = sum(cost),
                                   .groups = "drop")$cost)
grocery_last365 %>% 
  ggplot(aes(x = week, y = cost)) +
  geom_col(aes(fill = store_label)) +
  geom_hline(yintercept = mean_weekly_cost,
             linetype = "dashed", linewidth = 1.5) +
  annotate("label", x = as.Date(min(grocery_last365$week) - days(14)), 
           y = mean_weekly_cost, 
           label = round(mean_weekly_cost, 2)) +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  labs(title = "Grocery Expenses by Week",
       x = "Week",
       y = "Expenditure ($)",
       fill = NULL) +
  theme(axis.line = element_blank())
```

Below are plots of the number of trips per week and expenditure per week over time, to see if there is any directional or seasonal change.

```{r grocery-week-trips-cost, out.width="50%", fig.align="default"}
grocery_week_summary <- grocery_last365 %>%
  group_by(year, week) %>%
  summarize(trips = n(), cost = sum(cost), .groups = "drop")

grocery_week_summary %>% 
  ggplot(aes(x = week, y = trips)) +
  geom_line(col = "blue") +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE,
              col = "black", linetype = "dashed") +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  labs(title = "Trips to the Grocery Store by Week",
       x = "Week", 
       y = "Number of Trips")

grocery_week_summary %>% 
  ggplot(aes(x = week, y = cost)) +
  geom_line(col = "blue") +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE,
              col = "black", linetype = "dashed") +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  guides(size = guide_legend(nrow = 1)) +
  theme(legend.position = "top") +
  labs(title = "Grocery Expenses by Week",
       x = "Week", 
       y = "Expenditure ($)",
       size = "Trips")
```

The following plot displays the relationship between the number of trips taken per week and the total expenditure; each point represents one week. The blue line is a third-degree polynomial fit to the data to show the larger trend. Note that points have been jittered ($\pm$ 0.25 trips) to reduce overlap; trips can only be a whole number.

```{r grocery-weekly-cost}
week_fit <- lm(cost ~ poly(trips, 3), data = grocery_week_summary)
r2_week <- summary(week_fit)$r.squared

grocery_week_summary %>% 
  ggplot(aes(x = trips, y = cost)) +
  geom_jitter(width = 0.25, height = 0) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  scale_x_continuous(n.breaks = 10) +
  # scale_y_continuous(breaks = seq(0, max(sum(group_by(grocery_last365, week)$cost)), 25)) +
  labs(title = "Weekly Cost by Number of Trips",
       subtitle = paste0("R-squared = ", round(r2_week, 2)),
       x = "Trips per Week",
       y = "Weekly Expenditure ($)")
```

### Grocery Expenses by Month
We will now repeat each plot, this time aggregating over a month instead of week.

```{r grocery-month}
mean_monthly_cost <- mean(summarize(group_by(grocery_last365, month), 
                                    cost = sum(cost),
                                    .groups = "drop")$cost)
grocery_last365 %>% 
  group_by(year, month) %>% 
  ggplot(aes(x = month, y = cost)) +
  geom_col(aes(fill = store_label)) +
  geom_hline(yintercept = mean_monthly_cost,
             linetype = "dashed", linewidth = 1.5) +
  annotate("label", x = min(grocery_last365$month) - days(14), y = mean_monthly_cost, 
           label = round(mean_monthly_cost, 2)) +
  scale_x_date(breaks = "1 month", date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  labs(title = "Grocery Expenses by Month",
       x = NULL,
       y = "Expenditure ($)",
       fill = NULL) +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())
```

For the following plots, we will only show data for completed months; the current month is not included. 
```{r grocery-month-trips-cost, out.width="50%", fig.align="default"}
grocery_month_summary <- grocery_last365 %>% 
  filter(date < floor_date(today(), unit = "months")) %>% 
  group_by(year, month) %>% 
  summarize(trips = n(), cost = sum(cost), .groups = "drop")

grocery_month_summary %>% 
  ggplot(aes(x = month, y = trips)) +
  geom_line(col = "blue") +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE,
              col = "black", linetype = "dashed") +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  theme(legend.position = "bottom") +
  labs(title = "Trips to the Grocery Store by Month",
       x = "Month", 
       y = "Number of Trips",
       col = "Expenditure ($)")

grocery_month_summary %>% 
  ggplot(aes(x = month, y = cost)) +
  geom_line(col = "blue") +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE,
              col = "black", linetype = "dashed") +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  theme(legend.position = "top") +
  labs(title = "Grocery Expenses by Month",
       x = "Month", 
       y = "Expenditure ($)",
       size = "Trips")
```

```{r grocery-monthly-cost}
month_fit <- lm(cost ~ poly(trips, 3), data = grocery_month_summary)
r2_month <- summary(month_fit)$r.squared

grocery_month_summary %>% 
  ggplot(aes(x = trips, y = cost)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  scale_x_continuous(breaks = seq(2, max(count(grocery_last365, month)$n), 2)) +
  # scale_y_continuous(breaks = seq(0, max(sum(group_by(grocery_last365, month)$cost)), 50)) +
  labs(title = "Monthly Cost by Number of Trips",
       subtitle = paste0("R-squared = ", round(r2_month, 2)),
       x = "Trips",
       y = "Monthly Total ($)")
```


## Grocery Expenses by Store
The table below is sorted in descending order by number of trips.

```{r grocery-stores-week, out.width="50%", fig.align="default"}
grocery %>% 
  group_by(store) %>% 
  summarize(trips = n(), 
            mean_items = format(round(mean(items), 2), nsmall = 2),
            sd_items = format(round(sd(items), 2), nsmall = 2), 
            mean_cost = format(round(mean(cost), 2), nsmall = 2), 
            mean_cost_per_item = format(round(sum(cost) / sum(items), 2), nsmall = 2),
            min_cost = format(min(cost), nsmall = 2), 
            max_cost = format(max(cost), nsmall = 2)) %>% 
  arrange(desc(trips)) %>% 
  datatable()

grocery %>% 
  ggplot(aes(x = store_label, y = cost)) +
  geom_boxplot(varwidth = TRUE) +
  labs(title = "Distribution of Expenditures by Store",
       subtitle = paste0(format(min(grocery$date), "%m/%d/%Y"), " - ", 
                         format(max(grocery$date), "%m/%d/%Y")),
       x = NULL, 
       y = "Expenditure ($)") +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())

grocery %>% 
  ggplot(aes(x = store_label, y = items)) +
  geom_boxplot(varwidth = TRUE) +
  labs(title = "Distribution of Items per Trip by Store",
       subtitle = paste0(format(min(grocery$date), "%m/%d/%Y"), " - ", 
                         format(max(grocery$date), "%m/%d/%Y")),
       x = NULL, 
       y = "Number of Items Purchased") +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())
```

Note that for Trader Joe's and Wegmans, the number of items is counted manually, so errors may be present.

We will now plot the ratio of number of items and cost. Only stores that have been visited five or more times will be plotted, though all stores are included in the overall average cost line (dashed). The plot is slightly jittered ($\pm$ 0.5 items) to improve visualization.

```{r item-cost-scatterplot}
grocery %>% 
  filter(store_label != "Other") %>% # Only include stores that have been visited 3+ times
  ggplot(aes(x = items, y = cost, col = store)) +
  geom_jitter(size = 2, width = 0.5, height = 0) +
  geom_abline(intercept = 0, slope = sum(grocery$cost) / sum(grocery$items), 
              linetype = "dashed", linewidth = 1) +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  labs(title = "Grocery Stores by Average Item Cost",
       subtitle = paste0(format(min(grocery$date), "%m/%d/%Y"), " - ", 
                         format(max(grocery$date), "%m/%d/%Y")),
       caption = "Note: the dashed line is the overall average cost per item",
       x = "Number of Items Purchased",
       y = "Expenditure ($)",
       col = NULL) +
  theme(legend.position = "inside", legend.position.inside = c(0.1, 0.9), 
        plot.caption = element_text(hjust = 0))
```

The dashed line in the plot above represents the overall average cost per item (*x*-intercept = 0 items, slope = mean cost).

## Grocery Expenses by Day of Week
Do we spend more on groceries on certain days of the week? Which days do we most often find ourselves making a trip to the store?

```{r groceries-weekday, out.width="50%", fig.align="default"}
grocery %>% 
  mutate(day_of_week = wday(date, label = TRUE, abbr = FALSE, week_start = 1)) %>% 
  ggplot(aes(x = day_of_week, y = items)) +
  geom_boxplot(varwidth = TRUE) +
  labs(x = NULL,
       y = "Number of Items Purchased")

grocery %>% 
  mutate(day_of_week = wday(date, label = TRUE, abbr = FALSE, week_start = 1)) %>% 
  ggplot(aes(x = day_of_week, y = cost)) +
  geom_boxplot(varwidth = TRUE) +
  labs(x = NULL,
       y = "Expenditure ($)")
```


## Grocery Expenses by Shopper
One shopper may be more prone to over-buying than the other. Do we see this in the overall data trend? Does shopping together temper this tendency? Note that we did not begin tracking shopper until approximately August 2025.

```{r shopper-analysis}
grocery %>% 
  drop_na() %>% 
  # Add number of trips per shopper
  group_by(shopper) %>% 
  mutate(shopper_label = paste0(shopper, " (", n(), " trips)")) %>% 
  ungroup() %>% 
  ggplot(aes(x = items, y = cost, col = shopper_label)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  geom_smooth(data = grocery, mapping = aes(x = items, y = cost), 
              col = "black", linetype = "dashed",
              method = "lm", formula = "y ~ x", se = FALSE) +
  labs(title = "Items Purchased and Cost by Shopper",
       x = "Number of Items Purchased",
       y = "Expenditure ($)",
       col = NULL) +
  theme(legend.position = "inside", legend.position.inside = c(0.1, 0.9), 
        plot.caption = element_text(hjust = 0))
```

```{r shopper-distributions, out.width="50%", fig.align="default"}
grocery %>% 
  drop_na() %>% 
  group_by(shopper) %>% 
  summarize(trips = n(), 
            mean_items = format(round(mean(items), 2), nsmall = 2),
            sd_items = format(round(sd(items), 2), nsmall = 2), 
            mean_cost = format(round(mean(cost), 2), nsmall = 2), 
            sd_cost = format(round(sd(cost), 2), nsmall = 2),
            mean_cost_per_item = format(round(sum(cost) / sum(items), 2), nsmall = 2)) %>% 
  datatable()

grocery %>% 
  drop_na() %>% 
  ggplot(aes(x = shopper, y = cost)) +
  geom_boxplot(varwidth = TRUE) +
  labs(title = "Distribution of Expenditures by Shopper",
       x = NULL, 
       y = "Expenditure ($)") +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())

grocery %>% 
  drop_na() %>% 
  ggplot(aes(x = shopper, y = items)) +
  geom_boxplot(varwidth = TRUE) +
  labs(title = "Distribution of Items per Trip by Shopper",
       x = NULL, 
       y = "Number of Items Purchased") +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())
```

```{r shopper-assumptions, eval=FALSE}
# Not enough data to get a nice graph
plot_grid(grocery %>% 
            drop_na() %>% 
            ggplot(aes(cost)) +
            geom_histogram(bins = 15, col = "white", fill = "blue") +
            facet_wrap(~shopper),
          grocery %>% 
            drop_na() %>% 
            ggplot(aes(items)) +
            geom_histogram(bins = 15, col = "white", fill = "blue") +
            facet_wrap(~shopper) +
            theme(strip.background = element_blank(),
                  strip.text.x = element_blank()),
          nrow = 2)
```


```{r shopper-difference}
# t-test for difference of means in number of items and in total cost (check assumptions first!)
# Is this even worth doing since there is an obvious difference? Maybe create confidence interval for how many more items I/we buy than Anna?

```


# Credit Cards
To better examine overall spending, we will look at the monthly statements for each of our credit cards, as these are the primary means we use for purchasing things.
```{r credit-card-data, include=FALSE}
cc_sheet <- get_credit_card_data(authenticated)
cc <- cc_sheet %>% 
  arrange(date) %>% 
  mutate(date = as.Date(date),
         year = year(date),
         month = floor_date(date, unit = "month"))
```

## Credit Card Expenses by Month
Almost all of the credit cards have a statement due on a fixed day of the month (e.g. January 4th, February 4th, etc.), which means that their billing cycles can vary slightly in length. The USAA credit card has a fixed billing cycle of 31 days.

```{r monthly-credit-cards}
cc_total_cost <- cc %>% 
  group_by(year, month) %>% 
  summarize(cost = sum(cost), card = "Total",
            .groups = "drop") %>% 
  bind_rows(cc)
cc_total_cost$card <- factor(cc_total_cost$card, 
                             levels = c(setdiff(levels(as.factor(cc_total_cost$card)),
                                                "Total"), 
                                        "Total"))

cc_total_cost %>% 
  ggplot(aes(x = month, y = cost, col = card)) +
  geom_line() +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  scale_color_manual(values = c("PNC" = palette4[1], 
                                "Sapphire" = palette4[2],
                                "United" = palette4[3],
                                "USAA" = palette4[4],
                                "Total" = "black")) +
  theme(legend.position = "bottom") +
  labs(title = "Credit Card Expenses by Month",
       x = NULL, 
       y = "Statement Balance ($)",
       col = "Credit Card")
```

# Utilities
We will now examine the costs associated with utilities -- specifically, electricity, water, Internet, and cell phone. Unlike groceries and most other expenses, utilities are paid directly from our bank account (so we can avoid the processing fee). Water is billed on a quarterly schedule, while the rest are billed monthly. Internet is a fixed cost each month, while the others vary.
```{r utility-data, include=FALSE}
utilities_sheet <- get_utility_data(authenticated)
utilities <- utilities_sheet %>% 
  arrange(date) %>% 
  mutate(date = as.Date(date),
         year = year(date),
         month = floor_date(date, unit = "month"))
```

## Utility Expenses by Month
```{r monthly-utilities}
utilities_total_cost <- utilities %>% 
  group_by(year, month) %>% 
  summarize(cost = sum(cost), utility = "Total",
            .groups = "drop") %>% 
  bind_rows(utilities)
utilities_total_cost$utility <- factor(utilities_total_cost$utility, 
                                       levels = c(setdiff(levels(as.factor(utilities_total_cost$utility)),
                                                          "Total"), 
                                                  "Total"))

utilities_total_cost %>% 
  ggplot(aes(x = month, y = cost, col = utility)) +
  geom_line() +
  geom_point(size = 1) +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  scale_color_manual(values = c("Electricity" = palette4[2], 
                                "Water" = palette4[3],
                                "Phone" = palette4[1],
                                "Internet" = palette4[4],
                                "Total" = "black")) +
  theme(legend.position = "bottom") +
  labs(title = "Utility Costs by Month",
       x = NULL, 
       y = "Cost ($)",
       col = NULL)
```


## Utility Expenses by Quarter
Since water is billed on a quarterly, rather than monthly basis, we will aggregate the other utilities to match this scale. We lose detail (particularly for electricity) in this approach but gain a better understanding of the overall trend for all utilities with this standard basis of comparison.

Note: the current date is `r format(today(), "%m/%d/%Y")`, so the last quarter only contains `r (month(today())) %% 3` full month(s) of utility data. As such, we have scaled the data for the months we do have to a full quarter for each utility (except water, which uses the average of the previous water bills) and taken the sum of those scaled projections to get the quarterly total.

```{r quarterly-utilities}
utilities_qtr <- utilities %>% 
  mutate(quarter = yearquarter(date)) %>% 
  group_by(utility, quarter) %>% 
  summarize(cost = sum(cost), num_bills = n(), .groups = "drop")

utilities_qtr_cost <- utilities_qtr %>% 
  group_by(quarter) %>% 
  summarize(cost = sum(cost), utility = "Total",
            .groups = "drop") %>% 
  bind_rows(utilities_qtr)
utilities_qtr_cost$utility <- factor(utilities_qtr_cost$utility, 
                                     levels = levels(utilities_total_cost$utility))

utilities_qtr_proj <- utilities_qtr %>% 
  filter(utility != "Water", num_bills < 3, 
         quarter > yearquarter(as.Date("9/30/2024", "%m/%d/%Y"))) %>% 
  mutate(proj_cost = round(cost * (3 / num_bills), 2)) %>% 
  bind_rows(data.frame(utility = "Water", 
                       quarter = .$quarter[1],
                       proj_cost = round(mean(filter(utilities_qtr_cost, utility == "Water")$cost), 2))) %>%
  bind_rows(data.frame(utility = "Total", 
                       quarter = .$quarter[1],
                       cost = sum(.$cost), 
                       num_bills = sum(.$num_bills), 
                       proj_cost = round(sum(.$proj_cost), 2)),
            mutate(filter(utilities_qtr_cost, quarter == .$quarter[1] - 1),
                   proj_cost = cost))

utilities_qtr_cost %>% 
  filter(quarter < max(quarter)) %>% 
  ggplot(aes(x = quarter, y = cost, col = utility)) +
  geom_line() +
  geom_line(data = utilities_qtr_proj, aes(x = quarter, y = proj_cost, col = utility), linetype = 2) +
  scale_x_yearquarter(date_labels = "%b %Y") +
  scale_color_manual(values = c("Electricity" = palette4[2], 
                                "Water" = palette4[3],
                                "Phone" = palette4[1],
                                "Internet" = palette4[4],
                                "Total" = "black")) +
  theme(legend.position = "bottom") +
  labs(title = "Utility Costs by Quarter",
       subtitle = paste0("Projections based on ", filter(utilities_qtr_proj, utility == "Electricity", quarter == max(quarter))$num_bills, " months of bills from the current quarter."),
       x = "Quarter", 
       y = "Cost ($)",
       col = NULL)
```

# Overall Monthly Expenses
