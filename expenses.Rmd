---
title: "<center>Expenses</center>"
subtitle: "Table of Contents"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 8, fig.align = "center")

library(tidyverse)
library(googlesheets4)
library(scales)
library(plotly)
library(DT)
library(tsibble)
library(cowplot)

authenticated <- FALSE
tryCatch(
  {
    # Initial steps:
    #    - Create email.txt file (not included in Git repo)
    #    - Set use_oob = FALSE for initial run
    gs4_auth(email = read_lines("email.txt"), scopes = "spreadsheets.readonly", use_oob = TRUE)
    authenticated <- TRUE
  },
  error = function(err) {
    message("User is not authenticated.")
  })
source("tools/get_data.R")

theme_update(plot.title = element_text(hjust = 0.5), 
             plot.subtitle = element_text(hjust = 0.5),
             panel.background = element_blank(),
             panel.grid.major = element_blank(),
             panel.grid.minor = element_blank(),
             axis.line = element_line(color = "black"))
palette4 <- hue_pal()(4)
```

All data in this report is **`r if_else(authenticated, "REAL", "SIMULATED")`**.

# Groceries
Note: Costco records only include expenses for groceries, so as not to skew the object of the analysis. This requires counting grocery items and manually calculating tax (most groceries are taxed at 1%, but some, including alcohol, are taxed at 6%), so accuracy is unlikely to be 100%. Additionally, it can be difficult to tell if some items are grocery expenses or not from their abbreviated name on the receipt. Nevertheless, this effort is sufficient to capture most of the additional expenses associated with infrequent bulk purchases from the store.

```{r grocery-data, include=FALSE}
grocery_sheet <- get_grocery_data(authenticated)
grocery <- grocery_sheet %>% 
  arrange(date) %>% 
  mutate(date = as.Date(date),
         store = as.factor(store),
         cost_per_item = cost / items,
         shopper = as.factor(shopper),
         week = floor_date(date, unit = "week"),
         month = floor_date(date, unit = "month"),
         year = year(date)) %>% 
  group_by(store) %>% 
  mutate(store_label = as.factor(ifelse(n() < 5, "Other", as.character(store)))) %>% 
  ungroup()
grocery$store_label <- factor(grocery$store_label, 
                              levels = c(setdiff(levels(grocery$store_label), "Other"), 
                                         "Other")
)

grocery_last365 <- filter(grocery, date >= today() - days(365))
```

## Grocery Expenses over Time
### Grocery Expenses by Week
From 01/10/2025 (when we started continuously tracking trips to the grocery store) to `r format(max(grocery$date), "%m/%d/%Y")`, we went to the grocery store `r sum(grocery$date >= as.Date("2025-01-09"))` times: an average of `r round(sum(grocery$date >= as.Date("2025-01-09")) / as.numeric(difftime(max(grocery$date), as.Date("2025-01-09"), units = "weeks")), 2)` times per week.

Below is the total expenditure per week for the last 365 days, with each color in the stacked bar chart corresponding to the amount spent at a given store that week. Stores that have been visited less than five times are grouped as "Other".

```{r grocery-week}
mean_weekly_cost <- mean(summarize(group_by(grocery_last365, week), 
                                   cost = sum(cost),
                                   .groups = "drop")$cost)
grocery_last365 %>% 
  ggplot(aes(x = week, y = cost)) +
  geom_col(aes(fill = store_label)) +
  geom_hline(yintercept = mean_weekly_cost,
             linetype = "dashed", linewidth = 1.5) +
  annotate("label", x = as.Date(min(grocery_last365$week) - days(14)), 
           y = mean_weekly_cost, 
           label = round(mean_weekly_cost, 2)) +
  scale_x_date(date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  labs(title = "Grocery Expenses by Week",
       x = "Week",
       y = "Expenditure ($)",
       fill = NULL) +
  theme(axis.line = element_blank())
```

Below are plots of the number of trips per week and expenditure per week over time (since we began tracking in January 2025), to see if there is any directional or seasonal change. Only includes full weeks (does not include the current week, unlike the plot above).

```{r grocery-week-trips-cost, out.width="100%", warning=FALSE}
grocery_week_summary <- grocery %>%
  filter(date < floor_date(today(), unit = "week", week_start = 1)) %>% 
  group_by(year, week) %>%
  summarize(trips = n(), cost = sum(cost), .groups = "drop")

grocery_week_trips <- grocery_week_summary %>% 
  ggplot(aes(x = week, y = trips)) +
  geom_line(aes(text = paste0("Week: ", week, "<br>Trips: ", trips, 
                              "<br>Expenditure: $", cost),
                group = 1), 
            col = "blue") +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE,
              col = "black", linetype = "dashed") +
  scale_x_date(date_labels = "%b %Y") +
  labs(title = "Grocery Trips by Week",
       x = "Week", 
       y = "Number of Trips")
p1_week <- ggplotly(grocery_week_trips, tooltip = "text")

grocery_week_cost <- grocery_week_summary %>% 
  ggplot(aes(x = week, y = cost)) +
  geom_line(aes(text = paste0("Week: ", week, "<br>Expenditure: ", dollar(cost), 
                              "<br>Trips: ", trips),
                group = 1),
            col = "blue") +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE,
              col = "black", linetype = "dashed") +
  scale_x_date(date_labels = "%b %Y") +
  labs(title = "Grocery Expenses by Week",
       x = "Week", 
       y = "Expenditure ($)")
p2_week <- ggplotly(grocery_week_cost, tooltip = "text") %>% 
  layout(title = list(text = "Grocery Trips and Expenses by Week", x = 0.5))

subplot(p1_week, p2_week, nrows = 1, margin = 0.05, titleY = TRUE)
```

The following plot displays the relationship between the number of trips taken per week and the total expenditure; each point represents one week. The blue line is a third-degree polynomial fit to the data to show the larger trend. Note that points have been jittered ($\pm$ 0.25 trips) to reduce overlap; trips can only be a whole number.

```{r grocery-weekly-cost, warning=FALSE}
week_fit <- lm(cost ~ poly(trips, 3), data = grocery_week_summary)
r2_week <- summary(week_fit)$r.squared

grocery_week_trips_cost <- grocery_week_summary %>% 
  ggplot(aes(x = trips, y = cost)) +
  geom_jitter(aes(text = paste0("Week: ", week, "<br>Trips: ", trips, 
                                "<br>Expenditure: ", dollar(cost)),
                  group = 1), 
              width = 0.25, height = 0) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  scale_x_continuous(n.breaks = 10) +
  labs(title = "Weekly Cost by Number of Trips",
       subtitle = paste0("R-squared = ", round(r2_week, 2)),
       x = "Trips per Week",
       y = "Weekly Expenditure ($)")
ggplotly(grocery_week_trips_cost, tooltip = "text") # Need to re-add R-squared subtitle!
```

The R-squared value for the polynomial fit in the plot above is `r round(r2_week, 2)`.

### Grocery Expenses by Month
We will now repeat each plot, this time aggregating over a month instead of week. The bar chart only includes data for the past 365 days, but all other plots include data going back to January 2025.

```{r grocery-month}
mean_monthly_cost <- mean(summarize(group_by(grocery_last365, month), 
                                    cost = sum(cost),
                                    .groups = "drop")$cost)
grocery_last365 %>% 
  group_by(year, month) %>% 
  ggplot(aes(x = month, y = cost)) +
  geom_col(aes(fill = store_label)) +
  geom_hline(yintercept = mean_monthly_cost,
             linetype = "dashed", linewidth = 1.5) +
  annotate("label", x = min(grocery_last365$month) - days(14), y = mean_monthly_cost, 
           label = round(mean_monthly_cost, 2)) +
  scale_x_date(breaks = "1 month", date_labels = "%b %Y") +
  # scale_y_continuous(n.breaks = 10) +
  labs(title = "Grocery Expenses by Month",
       x = NULL,
       y = "Expenditure ($)",
       fill = NULL) +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())
```

For the following plots, we will only show data for completed months; the current month is not included. 
```{r grocery-month-trips-cost, out.width="100%", warning=FALSE}
grocery_month_summary <- grocery %>% 
  filter(date < floor_date(today(), unit = "months")) %>% 
  group_by(year, month) %>% 
  summarize(trips = n(), cost = sum(cost), .groups = "drop")

grocery_month_trips <- grocery_month_summary %>% 
  ggplot(aes(x = month, y = trips)) +
  geom_line(aes(text = paste0("<b>", format(month, "%B %Y"), "</b><br>Trips: ", trips, 
                              "<br>Expenditure: ", dollar(cost)),
                group = 1),
            col = "blue") +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE,
              col = "black", linetype = "dashed") +
  scale_x_date(date_labels = "%b %Y") +
  theme(legend.position = "bottom") +
  labs(title = "Grocery Trips by Month",
       x = "Month", 
       y = "Number of Trips")
p1_month <- ggplotly(grocery_month_trips, tooltip = "text")

grocery_month_cost <- grocery_month_summary %>% 
  ggplot(aes(x = month, y = cost)) +
  geom_line(aes(text = paste0("<b>", format(month, "%B %Y"), "</b><br>Expenditure: ", 
                              dollar(cost), "<br>Trips: ", trips),
                group = 1),,
            col = "blue") +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE,
              col = "black", linetype = "dashed") +
  scale_x_date(date_labels = "%b %Y") +
  theme(legend.position = "top") +
  labs(title = "Grocery Expenses by Month",
       x = "Month", 
       y = "Expenditure ($)")
p2_month <- ggplotly(grocery_month_cost, tooltip = "text") %>% 
  layout(title = list(text = "Grocery Trips and Expenses by Month", x = 0.5))

subplot(p1_month, p2_month, margin = 0.05, titleY = TRUE)
```

For the plot below, points have been jittered ($\pm$ 0.5 trips) to reduce overlap; trips can only be a whole number.

```{r grocery-monthly-cost, warning=FALSE}
month_fit <- lm(cost ~ poly(trips, 3), data = grocery_month_summary)
r2_month <- summary(month_fit)$r.squared

grocery_month_trips_cost <- grocery_month_summary %>% 
  ggplot(aes(x = trips, y = cost)) +
  geom_jitter(aes(text = paste0("<b>", format(month, "%B %Y"), "</b><br>Trips: ", trips, 
                               "<br>Expenditure: ", dollar(cost)),
                  group = 1),
              width = 0.5, height = 0) +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  scale_x_continuous(breaks = seq(2, max(count(grocery, month)$n), 2)) +
  labs(title = "Monthly Cost by Number of Trips",
       subtitle = paste0("R-squared = ", round(r2_month, 2)),
       x = "Trips",
       y = "Monthly Total ($)")
ggplotly(grocery_month_trips_cost, tooltip = "text") # Need to re-add R-squared subtitle!
```

The R-squared value for the polynomial fit in the plot above is `r round(r2_month, 2)`.

## Grocery Expenses by Store
The table below is sorted in descending order by number of trips.

```{r grocery-stores-week, out.width="50%", fig.align="default"}
grocery %>% 
  group_by(store) %>% 
  summarize(trips = n(), 
            mean_items = format(round(mean(items), 2), nsmall = 2),
            sd_items = format(round(sd(items), 2), nsmall = 2), 
            mean_cost = format(round(mean(cost), 2), nsmall = 2), 
            mean_cost_per_item = format(round(sum(cost) / sum(items), 2), nsmall = 2),
            min_cost = format(min(cost), nsmall = 2), 
            max_cost = format(max(cost), nsmall = 2)) %>% 
  arrange(desc(trips)) %>% 
  datatable()

grocery %>% 
  ggplot(aes(x = store_label, y = items)) +
  geom_boxplot(varwidth = TRUE) +
  labs(title = "Distribution of Items per Trip by Store",
       subtitle = paste0(format(min(grocery$date), "%m/%d/%Y"), " - ", 
                         format(max(grocery$date), "%m/%d/%Y")),
       x = NULL, 
       y = "Number of Items Purchased") +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())

grocery %>% 
  ggplot(aes(x = store_label, y = cost)) +
  geom_boxplot(varwidth = TRUE) +
  labs(title = "Distribution of Expenditures by Store",
       subtitle = paste0(format(min(grocery$date), "%m/%d/%Y"), " - ", 
                         format(max(grocery$date), "%m/%d/%Y")),
       x = NULL, 
       y = "Expenditure ($)") +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())
```

Note that for Trader Joe's and Wegmans, the number of items is counted manually, so errors may be present.

We will now plot the ratio of number of items and cost. Only stores that have been visited five or more times will be plotted, though all stores are included in the overall average cost line (dashed). The plot is slightly jittered ($\pm$ 0.5 items) to improve visualization.

```{r item-cost-scatterplot}
grocery %>% 
  filter(store_label != "Other") %>% # Only include stores that have been visited 5+ times
  ggplot(aes(x = items, y = cost, col = store)) +
  geom_jitter(size = 2, width = 0.5, height = 0) +
  geom_abline(intercept = 0, slope = sum(grocery$cost) / sum(grocery$items), 
              linetype = "dashed", linewidth = 1) +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  labs(title = "Grocery Stores by Average Item Cost",
       subtitle = paste0(format(min(grocery$date), "%m/%d/%Y"), " - ", 
                         format(max(grocery$date), "%m/%d/%Y")),
       caption = "Note: the dashed line is the overall average cost per item",
       x = "Number of Items Purchased",
       y = "Expenditure ($)",
       col = NULL) +
  theme(legend.position = "inside", legend.position.inside = c(0.1, 0.9), 
        plot.caption = element_text(hjust = 0))
```

The dashed line in the plot above represents the overall average cost per item (*x*-intercept = 0 items, slope = mean cost).

## Grocery Expenses by Day of Week
Do we spend more on groceries on certain days of the week? Which days do we most often find ourselves making a trip to the store?

```{r groceries-weekday, out.width="50%", fig.align="default"}
grocery %>% 
  mutate(day_of_week = wday(date, label = TRUE, abbr = FALSE, week_start = 1)) %>% 
  ggplot(aes(x = day_of_week, y = items)) +
  geom_boxplot(varwidth = TRUE) +
  labs(x = NULL,
       y = "Number of Items Purchased")

grocery %>% 
  mutate(day_of_week = wday(date, label = TRUE, abbr = FALSE, week_start = 1)) %>% 
  ggplot(aes(x = day_of_week, y = cost)) +
  geom_boxplot(varwidth = TRUE) +
  labs(x = NULL,
       y = "Expenditure ($)")
```


## Grocery Expenses by Shopper
One shopper may be more prone to over-buying than the other. Do we see this in the overall data trend? Does shopping together temper this tendency? Note that we did not begin tracking shopper until approximately August 2025. The plot is slightly jittered ($\pm$ 0.5 items) to improve visualization.

```{r shopper-analysis}
grocery %>% 
  drop_na() %>% 
  # Add number of trips per shopper
  group_by(shopper) %>% 
  mutate(shopper_label = paste0(shopper, " (", n(), " trips)")) %>% 
  ungroup() %>% 
  ggplot(aes(x = items, y = cost, col = shopper_label)) +
  geom_jitter(width = 0.5, height = 0) +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  geom_smooth(data = grocery, mapping = aes(x = items, y = cost), 
              col = "black", linetype = "dashed",
              method = "lm", formula = "y ~ x", se = FALSE) +
  labs(title = "Items Purchased and Cost by Shopper",
       x = "Number of Items Purchased",
       y = "Expenditure ($)",
       col = NULL) +
  theme(legend.position = "inside", legend.position.inside = c(0.1, 0.9), 
        plot.caption = element_text(hjust = 0))
```

```{r shopper-distributions, out.width="50%", fig.align="default"}
grocery %>% 
  drop_na() %>% 
  group_by(shopper) %>% 
  summarize(trips = n(), 
            mean_items = format(round(mean(items), 2), nsmall = 2),
            sd_items = format(round(sd(items), 2), nsmall = 2), 
            mean_cost = format(round(mean(cost), 2), nsmall = 2), 
            sd_cost = format(round(sd(cost), 2), nsmall = 2),
            mean_cost_per_item = format(round(sum(cost) / sum(items), 2), nsmall = 2)) %>% 
  datatable()

grocery %>% 
  drop_na() %>% 
  ggplot(aes(x = shopper, y = items)) +
  geom_boxplot(varwidth = TRUE) +
  labs(title = "Distribution of Items per Trip by Shopper",
       x = NULL, 
       y = "Number of Items Purchased") +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())

grocery %>% 
  drop_na() %>% 
  ggplot(aes(x = shopper, y = cost)) +
  geom_boxplot(varwidth = TRUE) +
  labs(title = "Distribution of Expenditures by Shopper",
       x = NULL, 
       y = "Expenditure ($)") +
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank())
```

```{r shopper-assumptions, eval=FALSE}
# Not enough data to get a nice graph
plot_grid(grocery %>% 
            drop_na() %>% 
            ggplot(aes(cost)) +
            geom_histogram(bins = 15, col = "white", fill = "blue") +
            facet_wrap(~shopper),
          grocery %>% 
            drop_na() %>% 
            ggplot(aes(items)) +
            geom_histogram(bins = 15, col = "white", fill = "blue") +
            facet_wrap(~shopper) +
            theme(strip.background = element_blank(),
                  strip.text.x = element_blank()),
          nrow = 2)
```


```{r shopper-difference}
# t-test for difference of means in number of items and in total cost (check assumptions first!)
# Is this even worth doing since there is an obvious difference? Maybe create confidence interval for how many more items I/we buy than Anna?

```


# Credit Cards
To better examine overall spending, we will look at the monthly statements for each of our credit cards, as these are the primary means we use for purchasing things.
```{r credit-card-data, include=FALSE}
cc_sheet <- get_credit_card_data(authenticated)
cc <- cc_sheet %>% 
  arrange(date) %>% 
  mutate(date = if_else(card == "Discover", as.Date(date) - 1, as.Date(date)),
         year = year(date),
         month = floor_date(date, unit = "month"))
```

## Credit Card Expenses by Month
Almost all of the credit cards have a statement due on a fixed day of the month (e.g. January 4th, February 4th, etc.), which means that their billing cycles can vary slightly in length. The USAA credit card has a fixed billing cycle of 31 days. The Discover card is paid off on the first of every month, however we will subtract one day from the payment dates so that they align with the month of expenses that they represent.

*[September 2025 has two entries for the USAA card because we switched from manually paying the bill (around the fifth of the month) to auto-paying on the first of the month. Consequently, we will use the same strategy as the Discover card, where one day is subtracted so that it accurately reflects the statement as a summary of that month.]*

```{r monthly-credit-cards}
cc_total_cost <- cc %>% 
  group_by(year, month) %>% 
  summarize(cost = sum(cost), card = "Total",
            .groups = "drop") %>% 
  bind_rows(cc)
cc_total_cost$card <- factor(cc_total_cost$card, 
                             levels = c(setdiff(levels(as.factor(cc_total_cost$card)),
                                                "Total"), 
                                        "Total"))

cc_cost_plot <- cc_total_cost %>% 
  ggplot(aes(x = month, y = cost, col = card, group = card,
             text = paste0("<b>", card, "</b><br><i>", format(month, "%B %Y"), 
                           "</i><br>Balance: ", dollar(cost)))) +
  geom_line() +
  scale_x_date(date_labels = "%b %Y") +
  scale_color_manual(values = c("Discover" = palette4[1], 
                                "Sapphire" = palette4[2],
                                "United" = palette4[3],
                                "USAA" = palette4[4],
                                "Total" = "black")) +
  labs(title = "Credit Card Expenses by Month",
       x = NULL, 
       y = "Statement Balance ($)",
       col = "Credit Card")
ggplotly(cc_cost_plot, tooltip = "text") %>% 
  layout(legend = list(x = 0.45, xanchor = "center", y = -0.1,
                       orientation = "h"))
```

# Utilities
We will now examine the costs associated with utilities -- specifically, electricity, water, Internet, and cell phone. Unlike groceries and most other expenses, utilities are paid directly from our bank account (to avoid the processing fee). Water is billed on a quarterly schedule, while the rest are billed monthly. Internet is a fixed cost each month, while the others vary. All utilities except electricity are billed at the beginning of the following month; electricity is billed at the end of the month (billing periods do not fully overlap with calendar months).
```{r utility-data, include=FALSE}
utilities_sheet <- get_utility_data(authenticated)
utilities <- utilities_sheet %>% 
  arrange(date) %>% 
  mutate(date = as.Date(date),
         year = year(date),
         month = floor_date(date, unit = "month"))
```

## Utility Expenses by Month
Points have been added to the line plot below to highlight the fact that water is billed on a quarterly basis, as opposed to the other utilities. Consequently, its line does not have a point at each month. This explains some of the spiking in the total that may otherwise appear confusing, as every three months essentially has an extra bill.
```{r monthly-utilities, warning=FALSE}
utilities_total_cost <- utilities %>% 
  # Try dividing the quarterly water bill over the three months it covers (smooths the Total line)
  group_by(year, month) %>% 
  summarize(cost = sum(cost), utility = "Total",
            .groups = "drop") %>% 
  bind_rows(utilities)
utilities_total_cost$utility <- factor(utilities_total_cost$utility, 
                                       levels = c(setdiff(levels(as.factor(utilities_total_cost$utility)),
                                                          "Total"), 
                                                  "Total"))

utilities_cost_plot <- utilities_total_cost %>% 
  ggplot(aes(x = month, y = cost, col = utility)) +
  geom_line() +
  geom_point(aes(text = paste0("<b>", utility, "</b><br><i>", format(month, "%B %Y"), 
                               "</i><br>Cost: ", dollar(cost)), 
                 group = utility), 
             size = 1) +
  scale_x_date(date_labels = "%b %Y") +
  scale_color_manual(values = c("Electricity" = palette4[2], 
                                "Water" = palette4[3],
                                "Phone" = palette4[1],
                                "Internet" = palette4[4],
                                "Total" = "black")) +
  labs(title = "Utility Costs by Month",
       x = NULL, 
       y = "Cost ($)",
       col = NULL)
ggplotly(utilities_cost_plot, tooltip = "text") %>% 
  layout(legend = list(x = 0.5, xanchor = "center", y = -0.1,
                       orientation = "h"))
```


## Utility Expenses by Quarter
Since water is billed on a quarterly, rather than monthly basis, we will aggregate the other utilities to match this scale. We lose detail (particularly for electricity) in this approach but gain a better understanding of the overall trend for all utilities with this standard basis of comparison.

Where data is incomplete, we have scaled the available bills to a full quarter for each utility (except water, which uses the average of the previous water bills) and taken the sum of those scaled projections to get the quarterly total. Solid lines denote a full quarter, while dashed lines are a projection based on the months that have already received bills for that utility. Some utilities may be complete before the end of the quarter, while others may not.

```{r quarterly-utilities, warning=FALSE}
utilities_qtr <- utilities %>% 
  mutate(quarter = yearquarter(date)) %>% 
  group_by(utility, quarter) %>% 
  summarize(cost = sum(cost), num_bills = n(), .groups = "drop")

utilities_qtr_cost <- utilities_qtr %>% 
  group_by(quarter) %>% 
  summarize(cost = sum(cost), utility = "Total",
            .groups = "drop") %>% 
  bind_rows(utilities_qtr)
utilities_qtr_cost$utility <- factor(utilities_qtr_cost$utility, 
                                     levels = levels(utilities_total_cost$utility))

# Construct projections data frame
proj_data <- utilities_qtr %>%
  filter(((utility != "Water" & num_bills < 3) | (utility == "Water" & num_bills < 1)),
         quarter > yearquarter(today()) - 1) %>%
  mutate(proj_cost = if_else(utility == "Water",
                             round(mean(filter(utilities_qtr_cost, utility == "Water")$cost), 2),
                             round(cost * (3 / num_bills), 2)))

if (nrow(proj_data) > 0) {
  total_row <- data.frame(utility = "Total",
                          quarter = proj_data$quarter[1],
                          cost = filter(utilities_qtr_cost, quarter == proj_data$quarter[1], 
                                        utility == "Total")$cost) %>% 
    mutate(proj_cost = cost + round(sum(proj_data$proj_cost) - sum(proj_data$cost), 2))
  prev_data <- filter(utilities_qtr_cost, quarter == proj_data$quarter[1] - 1) %>%
    mutate(proj_cost = cost)
  utilities_qtr_proj <- bind_rows(proj_data, total_row, prev_data)
  
  utilities_qtr_cost_plot <- utilities_qtr_cost %>% 
    # Show real data where we have it, even if the other utilities are incomplete for the quarter
    anti_join(filter(utilities_qtr_proj, quarter == max(quarter)), 
              by = join_by(quarter, utility)) %>% 
    ggplot(aes(x = quarter, y = cost, col = utility)) +
    # Plot the actual data first so legend displays solid lines
    geom_line(aes(text = paste0("<b>", utility, "</b><br><i>", quarter, 
                                "</i><br>Cost: ", dollar(cost)), 
                  group = utility)) +
    # Plot projections
    geom_line(data = utilities_qtr_proj, 
              aes(x = quarter, y = proj_cost, col = utility, group = utility, 
                  text = paste0("<b>", utility, " (Projected)</b><br><i>", quarter,
                                 "<br>Projected Cost: ", dollar(proj_cost))), 
              linetype = 2, show.legend = FALSE) +
    # Re-add most recent (complete) quarter to supersede projection hover text
    geom_line(data = filter(utilities_qtr_cost, quarter == min(utilities_qtr_proj$quarter)),
              aes(text = paste0("<b>", utility, "</b><br><i>", quarter, 
                                "</i><br>Cost: ", dollar(cost)), 
                  group = utility)) +
    scale_x_yearquarter(date_labels = "%b %Y") +
    scale_color_manual(values = c("Electricity" = palette4[2], 
                                  "Water" = palette4[3],
                                  "Phone" = palette4[1],
                                  "Internet" = palette4[4],
                                  "Total" = "black")) +
    labs(title = "Utility Costs by Quarter",
         x = NULL, 
         y = "Cost ($)",
         col = NULL)
} else {
  utilities_qtr_cost_plot <- utilities_qtr_cost %>% 
    ggplot(aes(x = quarter, y = cost, col = utility)) +
    geom_line(aes(text = paste0("<b>", utility, "</b><br><i>", quarter, 
                                "</i><br>Cost: ", dollar(cost)), 
                  group = utility)) +
    scale_x_yearquarter(date_labels = "%b %Y") +
    scale_color_manual(values = c("Electricity" = palette4[2], 
                                  "Water" = palette4[3],
                                  "Phone" = palette4[1],
                                  "Internet" = palette4[4],
                                  "Total" = "black")) +
    labs(title = "Utility Costs by Quarter",
         x = NULL, 
         y = "Cost ($)",
         col = NULL)
}

ggplotly(utilities_qtr_cost_plot, tooltip = "text") %>% 
  layout(legend = list(x = 0.5, xanchor = "center", y = -0.1,
                       orientation = "h"))
```

# Overall Monthly Expenses
Putting it all together, we will now plot all our major sources of expense together. Grocery totals will only include completed months, while credit cards and utilities may be incomplete for the current month. Note that while groceries are plotted separately, they are a part of the credit card expenses, and thus the total is not a sum of all the lines (doing so would double-count groceries).

**ADD INSURANCE EXPENSES**

```{r overall-monthly-costs, out.width="100%"}
total_cc <- filter(cc_total_cost, card == "Total") %>% 
  select(month, cost)
total_utils <- filter(utilities_total_cost, utility == "Total") %>% 
  select(month, cost)
total_costs <- full_join(total_cc, total_utils, by = "month") %>% 
  full_join(select(grocery_month_summary, month, cost), by = "month") %>% 
  drop_na() %>% 
  rename(cc = cost.x, utils = cost.y, groceries = cost) %>% 
  mutate(rent = 2685, total = cc + utils + rent) # Don't include groceries since they are already part of cc

total_cost_plot <- total_costs %>% 
  pivot_longer(!month, names_to = "expense", values_to = "cost") %>% 
  mutate(expense = factor(expense, levels = c("cc", "groceries", "rent", "utils", "total"),
                          labels = c("Credit Cards", "Groceries", "Rent", "Utilities", "Total"))) %>% 
  ggplot(aes(x = month, y = cost, col = expense, group = expense,
             text = paste0("<b>", expense, "</b><br><i>", format(month, "%B %Y"), 
                           "</i><br>Cost: ", dollar(cost)))) +
  geom_line() +
  scale_x_date(date_labels = "%b %Y") +
  scale_color_manual(values = c("Credit Cards" = palette4[1], 
                                "Groceries" = palette4[2],
                                "Rent" = palette4[3],
                                "Utilities" = palette4[4],
                                "Total" = "black")) +
  labs(title = "Overall Expenses by Month",
       x = NULL, 
       y = "Cost ($)",
       col = NULL)
ggplotly(total_cost_plot, tooltip = "text") %>% 
  layout(legend = list(x = 0.5, xanchor = "center", y = -0.1,
                       orientation = "h"))
```

Not surprisingly, changes in credit card spending is the biggest driver of the overall monthly expenses.
